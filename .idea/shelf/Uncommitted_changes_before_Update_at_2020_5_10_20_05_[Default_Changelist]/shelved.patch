Index: src/main/java/util/fileUtils/FileTreeLoader.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package util.fileUtils;\r\n\r\nimport controller.FileTree;\r\nimport controller.ProgressBarWindow;\r\nimport controller.ViewerPane;\r\nimport model.FileTreeItem;\r\n\r\nimport javafx.application.Platform;\r\nimport model.PictureNode;\r\nimport util.TaskThreadPools;\r\nimport util.httpUtils.HttpUtil;\r\nimport util.httpUtils.exception.RequestConnectException;\r\n\r\nimport javax.swing.filechooser.FileSystemView;\r\n\r\nimport java.io.File;\r\nimport java.net.URISyntaxException;\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\n\r\n/**\r\n * @since 2020/4/22\r\n * @author Hi lu\r\n */\r\npublic class FileTreeLoader implements Runnable {\r\n\r\n    private final FileTree fileTree;\r\n\r\n    public FileTreeLoader(FileTree fileTree) {\r\n        this.fileTree = fileTree;\r\n    }\r\n\r\n    public static String getDiskName(File file) {\r\n        FileSystemView fsv = FileSystemView.getFileSystemView();\r\n        return fsv.getSystemDisplayName(new File(file.toString()));\r\n    }\r\n\r\n    /**\r\n     * 深度遍历+多线程算法，当文件层数大于3时，启动多线程加载。\r\n     *\r\n     * 预加载\r\n     */\r\n    @Override\r\n    public void run() {\r\n        List<FileTreeItem> fileTreeItems = fileTree.getRootFileTreeItems();\r\n        int dirLevel = 0;\r\n        while (fileTreeItems.size() > 0) {\r\n            List<FileTreeItem> allChildren = new ArrayList<>();\r\n            for (FileTreeItem item : fileTreeItems) {\r\n                if (dirLevel < 3) {\r\n                    List<FileTreeItem> childList = loadChildren(item);\r\n                    if (childList != null) {\r\n                        allChildren.addAll(childList);\r\n                    }\r\n                } else {\r\n                    TaskThreadPools.executeOnCachedThreadPool(() -> {\r\n                        loadChildren(item);\r\n                    });\r\n                }\r\n            }\r\n            dirLevel++;\r\n            fileTreeItems = allChildren;\r\n        }\r\n    }\r\n\r\n    public List<FileTreeItem> loadChildren(FileTreeItem item) {\r\n        File curFile = item.getFile();\r\n        List<FileTreeItem> curChildren = new ArrayList<>();\r\n        File[] childFiles = curFile.listFiles(File::isDirectory);\r\n        if (childFiles == null) return null;\r\n        for (File childFile : childFiles) {\r\n            if(childFile.isHidden()) continue;\r\n            FileTreeItem child = new FileTreeItem(childFile, childFile.getName());\r\n            curChildren.add(child);\r\n        }\r\n        Platform.runLater(() -> {\r\n            item.setExpanded(false);\r\n            for (FileTreeItem child : curChildren) {\r\n                item.getChildren().add(child);\r\n            }\r\n        });\r\n        return curChildren;\r\n    }\r\n\r\n    /**\r\n     * about the cloud album of fileTree\r\n     *\r\n     * get by main\r\n     *\r\n     * post by menuPane\r\n     *\r\n     * @param fileTree fileTree\r\n     */\r\n    public static void getCloudImages(FileTree fileTree){\r\n        fileTree.setOpened(true);\r\n        ViewerPane.bottom.getChildren().add(ViewerPane.progressBarWindow.getProgressBar());\r\n        TaskThreadPools.execute(()->{\r\n            while (true) {\r\n                ProgressBarWindow.updateProgressBar(0);\r\n                try {\r\n                    HttpUtil.doGetPageImages(FileTree.cloudImageNoteList,0,4);\r\n                } catch (RequestConnectException | URISyntaxException exception) {\r\n                    /*\r\n                    连接出现错误，退出提示框\r\n                    */\r\n                    if(exception instanceof RequestConnectException){\r\n                        if (((RequestConnectException) exception).\r\n                                getDialogSel((RequestConnectException) exception)){\r\n                            Platform.runLater(\r\n                                    ()->ViewerPane.bottom.getChildren().\r\n                                            remove(ViewerPane.progressBarWindow.getProgressBar()));\r\n                            break;\r\n                        } else continue;\r\n                    }\r\n                }\r\n                fileTree.getCloudAlbum().getTreeNode().setImages();\r\n                Platform.runLater(()-> ViewerPane.setCurrentTreeNode(fileTree.getCloudAlbum().getTreeNode()));\r\n                Platform.runLater(()->ViewerPane.bottom.getChildren().remove(ViewerPane.progressBarWindow.getProgressBar()));\r\n                break;\r\n            }\r\n        });\r\n    }\r\n\r\n    public static void postCloudImages(){\r\n        ViewerPane.bottom.getChildren().add(ViewerPane.progressBarWindow.getProgressBar());\r\n        TaskThreadPools.execute(()->{\r\n            List<String> paths = new ArrayList<>();\r\n            List<PictureNode> pictureNodes = PictureNode.getSelectedPictures();\r\n            List<File> images = new ArrayList<>();\r\n            for(PictureNode pictureNode : pictureNodes){\r\n                images.add(pictureNode.getFile());\r\n            }\r\n            if(images.size() != 0){\r\n                for(File file : images){\r\n                    paths.add(file.getAbsolutePath());\r\n                }\r\n                while(true){\r\n                    try {\r\n                        HttpUtil.doPostJson(paths);\r\n                    } catch (URISyntaxException | RequestConnectException exception) {\r\n                            /*\r\n                             连接出现错误，退出提示框\r\n                            */\r\n                        if(exception instanceof RequestConnectException){\r\n                            if (((RequestConnectException) exception).\r\n                                    getDialogSel((RequestConnectException) exception)){\r\n                                Platform.runLater(\r\n                                        ()->ViewerPane.bottom.getChildren().\r\n                                                remove(ViewerPane.progressBarWindow.getProgressBar()));\r\n                                break;\r\n                            } else continue;\r\n                        }\r\n                    }\r\n                    Platform.runLater(()->ViewerPane.bottom.getChildren().remove(ViewerPane.progressBarWindow.getProgressBar()));\r\n                    break;\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- src/main/java/util/fileUtils/FileTreeLoader.java	(revision c298d977a414bdae7095e7af36b629dbfd4234a6)
+++ src/main/java/util/fileUtils/FileTreeLoader.java	(date 1589009932558)
@@ -114,8 +114,10 @@
                     }
                 }
                 fileTree.getCloudAlbum().getTreeNode().setImages();
-                Platform.runLater(()-> ViewerPane.setCurrentTreeNode(fileTree.getCloudAlbum().getTreeNode()));
-                Platform.runLater(()->ViewerPane.bottom.getChildren().remove(ViewerPane.progressBarWindow.getProgressBar()));
+                Platform.runLater(()-> {
+                    ViewerPane.bottom.getChildren().remove(ViewerPane.progressBarWindow.getProgressBar());
+                    ViewerPane.setCurrentTreeNode(fileTree.getCloudAlbum().getTreeNode());
+                });
                 break;
             }
         });
